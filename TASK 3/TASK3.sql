alter session set "_ORACLE_SCRIPT"=true;

CREATE TABLE TRAMXANG (
  MaTram INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TenTram NVARCHAR2(100) NOT null,
  DiaChi NVARCHAR2(100),
  SoDienThoai NVARCHAR2(10)
)

CREATE TABLE HANGHOA(
  MAHANGHOA INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TENHANGHOA NVARCHAR2(50) NOT NULL,
  DONGIA NUMBER(18,2) NOT NULL
)


CREATE TABLE TRUBOM(
  MATRU INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  SOHIEUTRU NVARCHAR2(20),
  ID_TRAMXANG INT NOT NULL,
  ID_HANGHOA INT NOT NULL,
  CONSTRAINT FK_TRAMXANG FOREIGN KEY (ID_TRAMXANG) REFERENCES TRAMXANG(MATRAM),
  CONSTRAINT FK_HANGHOA FOREIGN KEY (ID_HANGHOA) REFERENCES HANGHOA(MAHANGHOA)
  )

CREATE TABLE GIAODICH (
  MAGIAODICH INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_TRAM INT NOT NULL,
  ID_TRU INT NOT NULL,
  ID_HANGHOA INT NOT NULL,
  SOLIT NUMBER(18,2) NOT NULL,
  DONGIA NUMBER(18,2) NOT NULL,
  THANHTIEN NUMBER(18,2) NOT NULL,
  NGAYGIAODICH DATE NOT NULL,
  CONSTRAINT FK_GD_TRAMXANG FOREIGN KEY (ID_TRAM) REFERENCES TRAMXANG(MATRAM),
  CONSTRAINT FK_GD_TRUBOM FOREIGN KEY (ID_TRU) REFERENCES TRUBOM(MATRU),
  CONSTRAINT FK_GD_HANGHOA FOREIGN KEY (ID_HANGHOA) REFERENCES HANGHOA(MAHANGHOA)
)

CREATE INDEX IDX_GD_NGAYGD ON GIAODICH(NGAYGIAODICH);
CREATE INDEX IDX_GD_TRAM ON GIAODICH(ID_TRAM);
CREATE INDEX IDX_GD_HANGHOA ON GIAODICH(ID_HANGHOA);

-- Insert dữ liệu
--TRAM
INSERT INTO tramxang (tentram, diachi, sodienthoai) VALUES ('Trạm xăng Thủ Đức', 'Thủ Đức, TP HCM', '0912345678');
INSERT INTO tramxang (tentram, diachi, sodienthoai) VALUES ('Trạm xăng Phú Lâm', 'Quận 6, TP HCM', '0912365412');

--HANGHOA
INSERT INTO hanghoa (tenhanghoa, DONGIA) VALUES ('Xăng E5 RON 92-II',20090);
INSERT INTO hanghoa (tenhanghoa, DONGIA) VALUES ('Dầu DO 0,05S-II', 17900);
INSERT INTO hanghoa (tenhanghoa, DONGIA) VALUES ('Xăng E10 RON 95-III', 19840);
INSERT INTO hanghoa (tenhanghoa, DONGIA) VALUES ('Dầu KO', 17810);

--TRU THUDUC
INSERT INTO TRUBOM (sohieutru, ID_TRAMXANG, ID_HANGHOA) VALUES ('Tru 1 - E5', 1, 1);
INSERT INTO TRUBOM (sohieutru, ID_TRAMXANG, ID_HANGHOA) VALUES ('Tru 1 - DO', 1, 2);
INSERT INTO TRUBOM (sohieutru, ID_TRAMXANG, ID_HANGHOA) VALUES ('Tru 1 - E10', 1, 3);

--TRU Q6
INSERT INTO TRUBOM (sohieutru, ID_TRAMXANG, ID_HANGHOA) VALUES ('Tru 1 - E5', 2, 1);
INSERT INTO TRUBOM (sohieutru, ID_TRAMXANG, ID_HANGHOA) VALUES ('Tru 1 - DO', 2, 2);
INSERT INTO TRUBOM (sohieutru, ID_TRAMXANG, ID_HANGHOA) VALUES ('Tru 1 - KO', 2, 4);

SELECT * FROM TRUBOM

--GD THUDUC
INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (1, 1, 1, 10, 20090, 10*20090, TO_DATE('2025-08-23 08:30', 'YYYY-MM-DD HH24:MI'));

INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (1, 1, 1, 10, 20090, 10*20090, TO_DATE('2025-08-24 10:30', 'YYYY-MM-DD HH24:MI'));

INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (1, 2, 2, 30, 17900, 30*17900, TO_DATE('2025-08-24 09:30', 'YYYY-MM-DD HH24:MI'));

INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (1, 3, 3, 15, 19840, 10*19840, TO_DATE('2025-08-23 11:30', 'YYYY-MM-DD HH24:MI'));

--GD Q6
INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (2, 4, 1, 11, 20090, 11*20090, TO_DATE('2025-08-24 08:30', 'YYYY-MM-DD HH24:MI'));

INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (2, 5, 2, 5, 17900, 5*17900, TO_DATE('2025-08-23 08:30', 'YYYY-MM-DD HH24:MI'));

INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (2, 5, 2, 6, 17900, 6*17900, TO_DATE('2025-08-24 08:30', 'YYYY-MM-DD HH24:MI'));

INSERT INTO GIAODICH (ID_TRAM, ID_TRU, ID_HANGHOA, SOLIT, DONGIA, THANHTIEN, NGAYGIAODICH)
VALUES (2, 6, 4, 20, 17810, 20*17810, TO_DATE('2025-08-24 08:30', 'YYYY-MM-DD HH24:MI'));

SELECT * FROM GIAODICH g

--1. Lấy giao dịch của 1 trạm trong khoảng ngày
SELECT * 
FROM GIAODICH 
WHERE ID_TRAM = 1 --THUDUC
AND NGAYGIAODICH BETWEEN TO_DATE('2025-08-23', 'YYYY-MM-DD') AND TO_DATE('2025-08-25', 'YYYY-MM-DD')
ORDER BY NGAYGIAODICH;

--2. Tổng doanh thu theo ngày cho 1 trụ bơm
SELECT TRUNC(NGAYGIAODICH) AS NGAY, SUM(THANHTIEN) AS DOANHTHU
FROM GIAODICH 
WHERE ID_TRU = 1
GROUP BY TRUNC(NGAYGIAODICH)
ORDER BY NGAY;
  
--3. Tổng doanh thu theo ngày cho 1 trạm xăng
SELECT TRUNC(NGAYGIAODICH) AS NGAY, SUM(THANHTIEN) AS DOANHTHU
FROM GIAODICH 
WHERE ID_TRAM = 2 --Q6
GROUP BY TRUNC(NGAYGIAODICH)
ORDER BY NGAY;

--4. Lấy top 3 hàng hóa bán chạy nhất và tổng số lít tại 1 trạm trong tháng
SELECT H.TENHANGHOA, SUM(G.SOLIT) AS TONGSL 
FROM GIAODICH G
JOIN HANGHOA h ON G.ID_HANGHOA = h.MAHANGHOA
WHERE G.ID_TRAM = 1 --Q6
AND EXTRACT(MONTH FROM G.NGAYGIAODICH) = 8
AND  EXTRACT(YEAR FROM G.NGAYGIAODICH) = 2025
GROUP BY H.TENHANGHOA
ORDER BY TONGSL DESC
FETCH FIRST 3 ROWS ONLY;